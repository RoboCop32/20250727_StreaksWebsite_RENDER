<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Streak Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        .map-container {
            width: 1000px;
            height: 600px;
            margin: 20px auto;
            display: none;
            border: 2px solid black;
        }
        table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #222;
            color: white;
        }
        tr:hover {
            background-color: #f0f0f0;
            cursor: pointer;
        }
        button {
            margin: 10px;
            padding: 10px 15px;
            font-size: 16px;
            background-color: green;
            color: white;
            border: none;
            border-radius: 5px;
        }
        #filtered-table-section {
            display: none;
        }

		#welcome-screen.hidden {
		  opacity: 0;
		  pointer-events: none;
		}
		

		
		.info.legend {
		  background: white;
		  padding: 8px 12px;
		  border-radius: 8px;
		  box-shadow: 0 0 5px rgba(0,0,0,0.3);
		  font-size: 14px;
		  line-height: 18px;
		  text-align: left;
		}
		.info.legend h4 {
		  margin: 0 0 5px;
		  font-size: 14px;
		}
		
		
    </style>
</head>
<body>

	<div id="welcome-screen" style="position: fixed; z-index: 9999; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; align-items: center; justify-content: flex-start; flex-direction: column; overflow-y: auto; transition: opacity 0.5s ease;padding: 20px;" hidden>
	  <h1>Welcome to the Football Streak Finder App</h1>
	  <p>Ever wondered how many days of football fixturees you could attend consecutively? This app lets you achieve that!</p>
	  <p>This app looks into a database of every professional fixture planned for the 24/25 football season per country and returns consecutive fixtures</p>
	  <p></p>
	  <h2>How to Use:</h2>
	  <p>1. Firstly choose the amount of days between 2 fixtures that would define them as 'consecutive'. 
	  For example, if you choose 1, only fixtures that occur 1 day after each other will be returned as 'consecutive'. 
	  If you pick 7, fixtures that occur between 1-7 days after the previous fixture will be returned as 'consecutive'. And so on. This allows you to have breaks in between fixtures.
	  After inputting your 'day gap' and clicking Generate Football Streaks, the table of football streaks returns. 
	  Start and End date is when the streak starts and ends. Country and No. of fixtures are self explanatory</p>
	  <p>2. Click on a row. All the fixtures returned will be shown on a map and as a table underneath the map, with the date, home and away teams, and stadium.
	  Points are colour-coded based on their date - fixtures that share a date have the same colour.
	  By hovering over a row, the corresponding fixture on the map will light up. Click on a row to zoom to that fixture's location (based on the stadium).</p>
	  <p>3. Obviously on some dates there are multiple fixtures. By clicking Filter, the app filters to all the fixtures that maintain the streak but have the lowest overall distance between them.
	  Clicking Show Arrows after clicking Filter adds lines between these fixtures up in order of date.</p>
	  <p>4. If you want to begin again, click Show Table at the top to click on another streak, or type in another Day Gap value at the top.</p>
	  <button onclick="hideWelcome()">BEGIN</button>
	  <h2> Current leagues included: </h2>
	  <p>
	    <br> La Liga<br/>
		<br> La Liga 2<br/>
		<br> Primera RFEF - 1<br/>
		<br> Primera RFEF - 2<br/>
		<br> Ligue 1<br/>
		<br> Ligue 2<br/>
		<br> National (France)<br/>
		<br> Liga Portugal<br/>
		<br> Liga Portugal 2<br/>
		<br> Serie A<br/>
		<br> Serie B<br/>
		<br> Serie C - A<br/>
		<br> Serie C - B<br/>
		<br> Serie C - C<br/>
		<br> Chance Liga<br/>
		<br> Super League (Greece)<br/>
		<br> Liga 1<br/>
		<br> Liga 2<br/>
		<br> Super Liga<br/>
		<br> Parva Liga<br/>
		<br> Vtora Liga<br/>
		<br> ChNl<br/>
		<br> Eerste Divisie<br/>
		<br> Eredivise<br/>
		<br> Jupiler Pro League<br/>
		<br> Super League (Switzerland)<br/>
		<br> Challenger League<br/>
		<br> Super Lig<br/>
		<br> 2. Lig Red Group<br/>
		<br> BGL Ligue<br/>
		<br> Bundesliga Austria<br/>
		<br> Ekstraklasa<br/>
		<br> Division 1 (Poland)<br/>
		<br> Division 2 (Poland)<br/>
		<br> Premier Division (Ireland)<br/>
		<br> Division 1 (Ireland)<br/>
		<br> Superliga<br/>
		<br> 1st Division (Denmark)<br/>
		<br> NB I.<br/>
		<br> NB II.<br/>
		<br> HNL<br/>
		<br> Prva NL<br/>
		<br> Eliteserien<br/>
		<br> OBOS-ligaen<br/>
		<br> Allsvenskan<br/>
		<br> Superettan<br/>

	  </p>
	  <p>Disclaimer: Whilst every care is taken to ensure accuracy, the information provided in this website may not be complete or fully accurate. Please double-check before relying on it.</p>
	  <p>Any issues please contact: Sodu6xuS@proton.me</p>
	  <br></br>
	</div>
	

	
    <h2>Choose the amount of days between 2 fixtures that would define them as 'consecutive': (choose between 1–10)</h2>
    <form method="POST">
        <input type="number" name="streak_gap" required min="1" max="10" placeholder="Enter Day Gap" style="width: 150px;">
        <button type="submit">Generate Football Streaks!</button>
		
    </form>
	
	<button onclick="showWelcomeAgain()" style="
	  position: fixed;
	  top: 10px;
	  left: 10px;
	  margin: 10px;
	  padding: 10px 15px;
	  font-size: 16px;
	  background-color: green;
	  color: white;
	  border: none;
	  border-radius: 5px;
	">
	  i
	</button>
    {% if streak_shown %}



    <div id="data-table-container">
        <table id="data-table">
            <thead>
			<tr>
				<th colspan="5">
					<button id="toggle-table-btn">▲ Hide Table</button>
				</th>
			</tr>
                <tr>
					<th>Country</th>
                    <th>Start Date of Streak</th>
                    <th>End Date of Streak</th>           
                    <th>Number of Fixtures in Streak</th>
                </tr>
            </thead>
            <tbody>
                {% for row in df_data %}
				
                <tr onclick="toggleVisibility(document.querySelector('#data-table tbody'))" data-streak-id="{{ row.Streak_ID }}">
                    <td>{{ row.streak_country }}</td>
					<td>{{row.interval_start_date}}</td>
                    <td>{{ row.interval_end_date }}</td>                    
                    <td>{{ row.day_interval }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="map-container"></div>
	
	<div id="controls">
        <button id="filter-btn">Filter</button>
        <button id="toggle-lines-btn" style="display:none">Show Arrows</button>
    </div>

    <div id="filtered-table-section">
        <h3>Filtered Fixtures</h3>
        <table id="filtered-data-table">
            <thead>
                <tr>
                    <th>Date of Fixture</th>
                    <th>Home Team</th>
                    <th>Away Team</th>
                    <th>Fixture Stadium</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    {% endif %}

    <script>
	
	function cleanDate(d) {
		  const arr = d.split(" ");
		  const sliced = arr.slice(1, -2); 
		  const	joined = sliced.join(" ");	  
		  return joined; // take only YYYY-MM-DD
		}
	
	function hideWelcome() {
	  const welcome = document.getElementById("welcome-screen");
	  welcome.style.display = "none";
	  welcome.setAttribute("hidden", true);
	  sessionStorage.setItem("welcomeShown", "true");
	}

	function showWelcomeAgain() {
	const welcome = document.getElementById("welcome-screen");
	welcome.style.display = "flex";
	}
	
    function toggleVisibility(el) {
		
		console.log(el)
        if (el) el.style.display = (el.style.display === 'none') ? 'block' : 'none';
		console.log(el.style.display )
		document.getElementById("toggle-table-btn").textContent = "▲ Show Table"
    }

    function haversine(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function applyFilter(data) {
        const grouped = {};
        data.forEach(row => {
            if (!grouped[row.date]) grouped[row.date] = [];
            grouped[row.date].push(row);
        });

        const dates = Object.keys(grouped).sort();
        const result = [];

        for (let i = 0; i < dates.length; i++) {
            const curr = grouped[dates[i]];
            const next = grouped[dates[i + 1]] || [];
            let best = curr[0];
            let minDist = Infinity;
            curr.forEach(a => {
                next.forEach(b => {
                    const d = haversine(a.latitude, a.longitude, b.latitude, b.longitude);
                    if (d < minDist) {
                        best = a;
                        minDist = d;
                    }
                });
            });
            result.push(best);
        }
        return result;
    }

    let originalData = [], filteredData = [], showFiltered = false, map, markers = {}, lines;

    function renderMap(data, options = {}) {
		const container = document.querySelector(".map-container");
		if (!container) return;
		container.style.display = 'block';
		container.innerHTML = '<div id="leaflet-map" style="height:100%;width:100%"></div>';

		map = L.map('leaflet-map').setView([20, 0], 2);
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

		markers = {};
		const points = [];

		let colors = ["#e6194b", "#3cb44b", "#ffe119", "#4363d8", "#f58231", "#911eb4", "#46f0f0", "#f032e6", "#bcf60c", "#fabebe", "#008080", "#e6beff", "#9a6324", "#fffac8", "#800000", "#aaffc3", "#808000", "#ffd8b1", "#000075", "#808080"];
		let dateColors = {};
		let currentColorIndex = 0;

		const uniqueDates = [...new Set(data.map(row => row.date))].sort();
		uniqueDates.forEach(date => {
			dateColors[date] = colors[currentColorIndex % colors.length];
			currentColorIndex++;
		});
		
		// ✅ Add legend (date → color)
		if (!showFiltered) {
			const legend = L.control({ position: "bottomright" });
			legend.onAdd = function () {
				const div = L.DomUtil.create("div", "info legend");
				div.innerHTML = "<h4>Fixture Dates</h4>";
				uniqueDates.forEach(date => {
					div.innerHTML += `
						<div>
							<span style="display:inline-block;width:15px;height:15px;background:${dateColors[date]};margin-right:5px;"></span>
							${cleanDate(date)}
						</div>`;
				});
				return div;
			};
			legend.addTo(map);
		}
		
		// ✅ Build map of unique_id → all order numbers
		const orderMap = {};
		data
		  .slice()
		  .sort((a, b) => Date.parse(a.date) - Date.parse(b.date))
		  .forEach((row, idx) => {
			if (!orderMap[row.unique_id]) orderMap[row.unique_id] = [];
			orderMap[row.unique_id].push(idx + 1); // store 1-based index
			
		});
		 // ✅ Sort by date before drawing 
		data
		  .slice()
		  .sort((a, b) => Date.parse(a.date) - Date.parse(b.date))
		  .forEach((row, index) => {
			const { latitude: lat, longitude: lon, unique_id: id } = row;
			if (lat == null || lon == null) return;

			let popupText = `${row.date}: ${row.home} vs ${row.away}`;
			if (options.withArrows && index === 0) popupText = "START: " + popupText;
			else if (options.withArrows && index === data.length - 1) popupText = "END: " + popupText;

			const marker = L.circleMarker([lat, lon], {
				radius: 6,
				color: 'black',
				fillColor: dateColors[row.date],
				fillOpacity: 0.9
			}).addTo(map).bindPopup(popupText);
			
			if (showFiltered) {

				const orderLabels = orderMap[id].join(","); // e.g. "2,6"
				
				// Apply jitter
				const jitterAmount = 0.0002;
				const jitter = () => (Math.random() - 0.5) * 2 * jitterAmount;
				
				const jitteredLat = lat + jitter();
				const jitteredLon = lon + jitter();
				
				L.marker([jittered_lat, jittered_lon], {
					icon: L.divIcon({
						className: "order-label",
						html: `<b style="color:white;font-size:18.5px;text-shadow:-1px -1px 2px black,1px -1px 2px black,-1px 1px 2px black,1px 1px 2px black;">
								  ${orderLabels}
							   </b>`,
						iconSize: [30, 20],
						iconAnchor: [15, -10]
					})
				}).addTo(map);
			}

			markers[id] = marker;
			points.push([lat, lon]);
		});

		// ✅ Draw arrows in date order
		if (options.withArrows && points.length > 1) {
			lines = L.polyline(points, { color: 'red', weight: 4 }).addTo(map);
		}

		if (points.length) map.fitBounds(points);
	}	
		//welcome screen
	document.addEventListener("DOMContentLoaded", () => {
	  const welcome = document.getElementById("welcome-screen");
	  const alreadyShown = sessionStorage.getItem("welcomeShown");
	  console.log("SessionStorage says welcomeShown:", alreadyShown);
	  
	  if (alreadyShown === "true") {
		welcome.setAttribute("hidden", true);
		welcome.style.display = "none";
	  } else {
		welcome.removeAttribute("hidden");
		welcome.style.display = "flex";
	  }
	});


	
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll("#data-table tbody tr").forEach(tr => {
            tr.addEventListener("click", () => {
                const id = tr.dataset.streakId;
                fetch(`/get_streak/${id}`).then(res => res.json()).then(data => {
                    originalData = data.df_data;
                    filteredData = applyFilter(originalData);

                    const tbody = document.querySelector("#filtered-data-table tbody");
                    tbody.innerHTML = "";
                    originalData.forEach(row => {
                        const tr = document.createElement("tr");
                        tr.dataset.id = row.unique_id;
                        tr.dataset.lat = row.latitude;
                        tr.dataset.lon = row.longitude;
                        tr.innerHTML = `<td>${cleanDate(row.date)}</td><td>${row.home}</td><td>${row.away}</td><td>${row["Stadium Name"]}</td>`;
                        tbody.appendChild(tr);
						
						
										// add hover + click now (markers will exist after renderMap runs)
						tr.addEventListener("mouseover", () => markers[row.unique_id]?.setStyle({ color: 'yellow', radius: 12 }));
						tr.addEventListener("mouseout", () => markers[row.unique_id]?.setStyle({ color: 'black', radius: 6 }));
						tr.addEventListener("click", () => {
							const marker = markers[row.unique_id];
							if (marker) {
								marker.openPopup();
								map.setView(marker.getLatLng(), 10, { animate: true });
							}
						});
						
						
                    });

                    renderMap(originalData);
                    document.getElementById("filtered-table-section").style.display = 'block';
					
                });
            });
        });

        document.getElementById("filter-btn").addEventListener("click", () => {
			showFiltered = !showFiltered;
			const arrowBtn = document.getElementById("toggle-lines-btn");

			// ✅ Always hide arrows + reset button text
			arrowBtn.style.display = showFiltered ? "inline-block" : "none";
			arrowBtn.textContent = "Show Arrows";

			// ✅ Pick the correct dataset
			const data = showFiltered ? filteredData : originalData;

			// ✅ Render map without arrows
			renderMap(data);

			// ✅ Rebuild the table (sorted by date)
			const tbody = document.querySelector("#filtered-data-table tbody");
			tbody.innerHTML = "";
			data
			  .slice()
			  .sort((a, b) => Date.parse(a.date) - Date.parse(b.date))
			  .forEach(row => {
				const tr = document.createElement("tr");
				tr.dataset.id = row.unique_id;
				tr.dataset.lat = row.latitude;
				tr.dataset.lon = row.longitude;
				tr.innerHTML = `
				  <td>${cleanDate(row.date)}</td>
				  <td>${row.home}</td>
				  <td>${row.away}</td>
				  <td>${row["Stadium Name"]}</td>
				`;
				tbody.appendChild(tr);

				// ✅ Attach hover/click
				tr.addEventListener("mouseover", () => markers[row.unique_id]?.setStyle({ color: 'yellow', radius: 12 }));
				tr.addEventListener("mouseout", () => markers[row.unique_id]?.setStyle({ color: 'black', radius: 6 }));
				tr.addEventListener("click", () => {
					const marker = markers[row.unique_id];
					if (marker) {
						marker.openPopup();
						map.setView(marker.getLatLng(), 10, { animate: true });
					}
				});
			  });

			// ✅ Update filter button text
			document.getElementById("filter-btn").textContent = showFiltered ? "Show Original" : "Filter";
		});

		document.getElementById("toggle-lines-btn").addEventListener("click", () => {
			const btn = document.getElementById("toggle-lines-btn");
			const data = showFiltered ? filteredData : originalData;

			if (btn.textContent.includes("Show")) {
				btn.textContent = "Hide Arrows";
				renderMap(data, { withArrows: true }); // ← pass flag to draw arrows
			} else {
				btn.textContent = "Show Arrows";
				renderMap(data, { withArrows: false }); // ← redraw without arrows
			}
		});
    });
	
	//show/hide Table
	const toggleTableBtn = document.getElementById("toggle-table-btn");
    const tableBody = document.querySelector("#data-table tbody"); //so this is the name of our table

    // Toggle table visibility when the button is clicked
    toggleTableBtn.addEventListener("click", function () {
        if (tableBody.style.display === "none") {
            tableBody.style.display = "table-row-group"; // Show table
            toggleTableBtn.textContent = "▼ Hide Table";
        } else {
            tableBody.style.display = "none"; // Hide table
            toggleTableBtn.textContent = "▼ Show Table";
        }
    });
	

    </script>
</body>
</html>
