<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Stadium Explorer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
  :root { --gap: 14px; }
  background: #59A6FF; 
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 18px; }
  header { display:flex; align-items:center; gap: 12px; margin-bottom: 12px; }
  .btn { padding: 8px 12px; border:1px solid #ddd; border-radius:10px; text-decoration:none; color:#111; background:#fafafa }
  .btn:hover { background:#f0f0f0 }

  .card { border:1px solid #e7e7e7; border-radius:12px; padding:12px; background:#fff; position:relative; }

  /* Filters: 3 thin columns in a row */
  .filters-row {
    display:grid;
    grid-template-columns: repeat(3, minmax(160px, 1fr));
    gap: var(--gap);
    margin-bottom: var(--gap);
  }
  .filter { display:flex; flex-direction:column; gap:6px; }
  label { font-weight:600; font-size: 14px; }
  select[multiple] {
    min-height: 180px;
    border:1px solid #ddd; border-radius:10px; padding:8px;
    font-size: 14px; background:#fff;
  }
  .count-badge { font-weight:400; color:#666; margin-left:6px; }

  /* Map full-width under filters */
  #mapCard { margin-top: 4px; }
  #map { width: 100%; min-height: 420px; border-radius:10px; }

  /* Results table under the map */
  #tableCard { margin-top: var(--gap); }
  table { width:100%; border-collapse: collapse; font-size: 14px; }
  th, td { padding: 8px 10px; border-bottom:1px solid #eee; text-align:left; }
  th { background:#fafafa; position:sticky; top:0; z-index:1; }

  .actions { display:flex; gap:8px; align-items:center; }
  .actions .btn { padding:6px 10px; }
</style>
</head>
<body>
  <header>
    <h2 style="margin:0">Stadium Explorer</h2>
    <div style="display:flex; gap:8px;">
		<a class="btn" href="/">← Home</a>
    </div>
  </header>

  <div class="card">
  <div class="filters-row">
    <div class="filter">
      <label>Country <span class="count-badge" id="country-count"></span></label>
      <select id="country" multiple></select>
    </div>
    <div class="filter">
      <label>League <span class="count-badge" id="league-count"></span></label>
      <select id="league" multiple></select>
    </div>
    <div class="filter">
      <label>Club <span class="count-badge" id="club-count"></span></label>
      <select id="club" multiple></select>
    </div>
  </div>

  <div class="actions">
    <button id="clearBtn" class="btn">Clear</button>
    <span id="status" aria-live="polite"></span>
  </div>
</div>

<div id="mapCard" class="card">
  <div id="map"></div>
</div>

<div id="tableCard" class="card">
  <table>
    <thead>
      <tr>
        <th>Country</th>
        <th>League</th>
        <th>Club</th>
        <th>Stadium</th>
        <th>Capacity</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

 <script>
  // Preloaded distincts injected by Flask:
  const preload = {{ preload|tojson|safe }};

  // ---------- helpers ----------
  function optHtml(arr){ return ['<option value="">(any)</option>'].concat((arr||[]).map(v=>`<option>${v}</option>`)).join(''); }
  function selVals(id){ return Array.from(document.getElementById(id).selectedOptions).map(o=>o.value).filter(Boolean); }
  function fill(id, arr){
    const el = document.getElementById(id);
    const prev = new Set(selVals(id));
    el.innerHTML = optHtml(arr);
    Array.from(el.options).forEach(opt => { if (prev.has(opt.value)) opt.selected = true; });
    refreshCountBadges();
  }
  function refreshCountBadges(){
    const n = k => document.querySelectorAll(`#${k} option:checked`).length;
    const set = (k,v)=>{ const el = document.getElementById(`${k}-count`); if (el) el.textContent = v ? `(${v} selected)` : ''; };
    set('country', n('country')); set('league', n('league')); set('club', n('club'));
  }
  function enableToggleMulti(id){
    const el = document.getElementById(id);
    el.addEventListener('mousedown', (e) => {
      const opt = e.target;
      if (opt && opt.tagName === 'OPTION') {
        e.preventDefault();
        opt.selected = !opt.selected;
        el.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });
  }
  ["country","league","club"].forEach(enableToggleMulti);

  function currentFilters(){
    return {
      country: selVals("country"),
      league:  selVals("league"),
      club:    selVals("club"),
    };
  }

  const statusEl = document.getElementById('status');
  function setStatus(msg){ statusEl.textContent = msg || ''; }

  // ---------- cascade options ----------
  async function refreshCascades(){
    const f = encodeURIComponent(JSON.stringify(currentFilters()));
    // refresh in order so each is scoped by those to its left
    for (const id of ["country","league","club"]){
      const r = await fetch(`/api/options?column=${id}&filters=${f}`);
      const data = await r.json();
      fill(id, data.values || []);
    }
  }

  // ---------- data search + render ----------
  let map, markersLayer;

  function ensureMap(){
    if (!map){
      map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      // initial safe view
      map.setView([20, 0], 2);
      // ensure map renders if container was sized after init
      setTimeout(()=> map.invalidateSize(), 0);
    }
  }

  function renderMarkers(markers){
    markersLayer.clearLayers();
    if (!markers || !markers.length){
      map.setView([20, 0], 2);
      map.invalidateSize();
      return;
    }
    const bounds = [];
    markers.forEach(m => {
      const marker = L.marker([m.lat, m.lng]).bindPopup(
        `<strong>${m.stadium}</strong><br/>${m.club} — ${m.league}<br/><small>${m.country}</small>`
      );
      marker.addTo(markersLayer);
      bounds.push([m.lat, m.lng]);
    });
    try { map.fitBounds(bounds, {padding:[20,20]}); } catch {}
    map.invalidateSize();
  }

  function renderTable(rows){
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = (rows||[]).map(r => `
      <tr>
        <td>${r.country || ''}</td>
        <td>${r.league || ''}</td>
        <td>${r.club || ''}</td>
        <td>${r.stadium || ''}</td>
        <td>${r.capacity ?? ''}</td>
      </tr>
    `).join('');
  }

  async function search(){
    setStatus('Loading…');
    const f = encodeURIComponent(JSON.stringify(currentFilters()));
    const res = await fetch(`/api/stadiums/search?filters=${f}`);
    const {rows, markers} = await res.json();
    renderTable(rows);
    ensureMap();
    renderMarkers(markers);
    setStatus(`${rows.length || 0} result${(rows.length||0)===1?'':'s'}`);
  }

  // ---------- live behavior (like Fixtures) ----------
  // preload selects (includes club from backend)
  ["country","league","club"].forEach(id => fill(id, preload[id] || []));

  // Like Fixtures: change in any select => cascade + search (debounced)
  let t;
  function kick(){
    clearTimeout(t);
    t = setTimeout(async ()=>{ await refreshCascades(); await search(); }, 120);
  }
  ["country","league","club"].forEach(id => {
    document.getElementById(id).addEventListener('change', kick);
  });

  document.getElementById("clearBtn").addEventListener("click", async ()=>{
    ["country","league","club"].forEach(id => document.getElementById(id).selectedIndex = -1);
    await refreshCascades();
    await search();
  });

  // initial
  ensureMap();
  refreshCountBadges();
  (async ()=>{ await refreshCascades(); await search(); })();
</script>
</body>
</html>