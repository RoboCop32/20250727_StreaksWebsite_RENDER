<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Stadium Explorer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
  .info-btn {
  position: fixed;
  top: 10px;
  right: 10px;
  z-index: 9990;
  margin: 0;
  padding: 8px 12px;
  font-size: 16px;
  font-weight: 600;
  color: #383838;
  background: #ffffff;
  border: 1px solid #ddd;
  border-radius: 999px;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
}
.info-btn:hover {
  background: #f5f5f5;
}
	#begin-btn {
	background: #59A6FF;       /* blue like your theme */
	color: #000000;
	border: none;
	border-radius: 12px;
	padding: 14px 30px;
	font-size: 35px;
	font-weight: 600;
	cursor: pointer;
	transition: background 0.2s ease, transform 0.1s ease;
	box-shadow: 0 3px 6px rgba(0,0,0,0.2);
	}

	#begin-btn:hover {
	background: #2E8BFF;
	transform: translateY(-2px);
	}
  :root { --gap: 14px; }
  
  body {background: #59A6FF; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 18px; }
  header { display:flex; align-items:center; gap: 12px; margin-bottom: 12px; }
  .btn { padding: 8px 12px; border:1px solid #ddd; border-radius:10px; text-decoration:none; color:#111; background:#fafafa }
  .btn:hover { background:#f0f0f0 }

  .card { border:1px solid #e7e7e7; border-radius:12px; padding:12px; background:#fff; position:relative; }
	
	/* full-page, mobile-friendly welcome overlay */
#welcome-screen {
  position: fixed;
  inset: 0;              /* top/right/bottom/left: 0 */
  z-index: 9999;
  display: none;         /* shown as flex in JS */
  background: #ffffff;
  box-sizing: border-box;
  padding: 24px 20px 32px;
  overflow-y: auto;
  overflow-x: hidden;
}

/* slightly more breathing room on tablets/desktop */
@media (min-width: 768px) {
  #welcome-screen {
    padding: 40px 60px;
  }
}

/* keep content neatly centred with safe margins */

/* optional: tidy up typography inside the overlay */
#welcome-screen h1 {
  margin-top: 0;
  margin-bottom: 12px;
  font-size: clamp(26px, 4.5vw, 36px);
}

#welcome-screen p,
#welcome-screen br {
  line-height: 1.5;
}
	
	#welcome-screen.hidden { opacity:0; pointer-events:none; }
  /* Filters: 3 thin columns in a row */
  .filters-row {
    display:grid;
    grid-template-columns: repeat(3, minmax(160px, 1fr));
    gap: var(--gap);
    margin-bottom: var(--gap);
  }
  .filter { display:flex; flex-direction:column; gap:6px; }
  label { font-weight:600; font-size: 14px; }
  select[multiple] {
    min-height: 180px;
    border:1px solid #ddd; border-radius:10px; padding:8px;
    font-size: 14px; background:#fff;
  }
  .count-badge { font-weight:400; color:#666; margin-left:6px; }

  .two-col {
  display: grid;
  grid-template-columns: 1.6fr 1fr;
  gap: var(--gap);
}

@media (max-width: 1100px) {
  .two-col {
    grid-template-columns: 1fr;
  }
}
  #map { width: 100%; min-height: 480px; border-radius: 10px; }
  #tableCard { max-height: 480px; overflow: auto; }
  /* Make table rows show a pointer cursor and subtle hover effect */
	#tableCard table tbody tr {
	  cursor: pointer;
	  transition: background 0.15s ease;
	}
	#tableCard table tbody tr:hover {
	  background: #eef6ff; /* light blue highlight on hover */
	}

table {
  width: 100%;
  min-width: 720px;
  border-collapse: collapse;
}
</style>
</head>
	
<body>
<button class = "info-btn" onclick="showWelcomeAgain()">i</button>
    
<div id="welcome-screen" hidden>
	  <h1>Stadiums - Mapped</h1>
	  
	  <p>Stadiums locations were geocoded based on the team name and country, using the nominatim API. Where the stadium was not found, the name of the town was geocoded. Where no information was found, nothing was geocoded - these will have to be added in manually at a later date (when I can be bothered!). </p>
	  <p>Out of 1013 teams, 749 were geocoded to the stadium, 219 were geocoded to the town, and 45 were not geocoded. However those that were geocoded can sometimes be wrong, e.g. if a stadium has an address name e.g. Vicarage Road (Watford). A long way of saying- not all of this is correct; manual checks are needed! If you see any that are wrong feel free to email footballmapped@proton.me.</p>
	  <p>You can hover over any row to highlight its stadium on the map, or click a row to zoom in and open its popup.</p>
	  <p>Click the <strong>“i”</strong> button any time to revisit this page.</p>
	  <button id="begin-btn" onclick="hideWelcome()" >BEGIN</button>
	  <h3> Current leagues included: </h3>
	  
	    <br> Premier League - England</br>
		<br> Championship - England</br>
		<br> League One - England</br>
		<br> League Two - England</br>
		<br> National League - England</br>
		<br> National League North - England</br>
		<br> National League South - England</br>
		<br> Scottish Premiership - Scotland</br>
		<br> Scottish Championship - Scotland</br>
		<br> Bundesliga - Germany</br>
		<br> Bundesliga 2 - Germany</br>
		<br> Bundesliga 3 - Germany</br>
		<br> La Liga - Spain<br/>
		<br> La Liga 2 - Spain<br/>
		<br> Primera RFEF - 1 - Spain<br/>
		<br> Primera RFEF - 2 - Spain<br/>
		<br> Ligue 1 - France<br/>
		<br> Ligue 2 - France<br/>
		<br> National (France) - France<br/>
		<br> Liga Portugal - Portugal<br/>
		<br> Liga Portugal 2 - Portugal<br/>
		<br> Serie A - Italy<br/>
		<br> Serie B - Italy<br/>
		<br> Serie C - A - Italy<br/>
		<br> Serie C - B - Italy<br/>
		<br> Serie C - C - Italy<br/>
		<br> Chance Liga - Czech Republic<br/>
		<br> Super League (Greece) - Greece<br/>
		<br> Liga 1 - Romania<br/>
		<br> Liga 2 - Romania<br/>
		<br> Super Liga - Serbia<br/>
		<br> Parva Liga - Bulgaria<br/>
		<br> Vtora Liga - Bulgaria<br/>
		<br> ChNl - Czech Republic<br/>
		<br> Eerste Divisie - Netherlands<br/>
		<br> Eredivise - Netherlands<br/>
		<br> Jupiler Pro League - Belgium<br/>
		<br> Super League (Switzerland) - Switzerland<br/>
		<br> Challenger League - Switzerland<br/>
		<br> Super Lig - Turkey<br/>
		<br> 2. Lig Red Group - Turkey<br/>
		<br> BGL Ligue - Luxembourg<br/>
		<br> Bundesliga Austria - Austria<br/>
		<br> Ekstraklasa - Poland<br/>
		<br> Division 1 (Poland) - Poland<br/>
		<br> Division 2 (Poland) - Poland<br/>
		<br> Premier Division (Ireland) - Ireland<br/>
		<br> Division 1 (Ireland) - Ireland<br/>
		<br> Superliga - Denmark<br/>
		<br> 1st Division (Denmark) - Denmark<br/>
		<br> NB I. - Hungary<br/>
		<br> NB II. - Hungary<br/>
		<br> HNL - Croatia<br/>
		<br> Prva NL - Croatia<br/>
		<br> Eliteserien - Norway<br/>
		<br> OBOS-ligaen - Norway<br/>
		<br> Allsvenskan - Sweden<br/>
		<br> Superettan - Sweden<br/>
	  
	  <p>Disclaimer: Whilst every care is taken to ensure accuracy, the information provided in this website may not be complete or fully accurate. Please double-check before relying on it.</p>
	  <p>Any issues please contact: footballmapped@proton.me</p>
	  <br></br>
	</div>
  <header>
    <h2 style="margin:0">Stadium Explorer</h2>
    <div style="display:flex; gap:8px;">
		<a class="btn" href="/">← Home</a>
    </div>
  </header>

<div class="card">
  <div class="filters-row">
    <div class="filter">
      <label>Country <span class="count-badge" id="country-count"></span></label>
      <select id="country" multiple></select>
    </div>
    <div class="filter">
      <label>League <span class="count-badge" id="league-count"></span></label>
      <select id="league" multiple></select>
    </div>
    <div class="filter">
      <label>Club <span class="count-badge" id="club-count"></span></label>
      <select id="club" multiple></select>
    </div>
  </div>

  <div class="actions">
    <button id="clearBtn" class="btn">Clear</button>
    <span id="status" aria-live="polite"></span>
  </div>

  <div class="two-col">
    <div id="mapCard" class="card">
      <div id="map"></div>
    </div>
    <div id="tableCard" class="card">

  <div id="tableCard" class="card">
    <table>
      <thead>
        <tr>
          <th>Team Name</th>
          <th>Country</th>
          <th>Stadium Name</th>
          <th>Longitude</th>
          <th>Latitude</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

 <script>
  // Preloaded distincts injected by Flask:
  const preload = {{ preload|tojson|safe }};

  // ---------- helpers ----------
  function optHtml(arr){ return ['<option value="">(any)</option>'].concat((arr||[]).map(v=>`<option>${v}</option>`)).join(''); }
  function selVals(id){ return Array.from(document.getElementById(id).selectedOptions).map(o=>o.value).filter(Boolean); }
  function fill(id, arr){
    const el = document.getElementById(id);
    const prev = new Set(selVals(id));
    el.innerHTML = optHtml(arr);
    Array.from(el.options).forEach(opt => { if (prev.has(opt.value)) opt.selected = true; });
    refreshCountBadges();
  }
  function refreshCountBadges(){
    const n = k => document.querySelectorAll(`#${k} option:checked`).length;
    const set = (k,v)=>{ const el = document.getElementById(`${k}-count`); if (el) el.textContent = v ? `(${v} selected)` : ''; };
    set('country', n('country')); set('league', n('league')); set('club', n('club'));
  }
  function enableToggleMulti(id){
    const el = document.getElementById(id);
    el.addEventListener('mousedown', (e) => {
      const opt = e.target;
      if (opt && opt.tagName === 'OPTION') {
        e.preventDefault();
        opt.selected = !opt.selected;
        el.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });
  }
  ["country","league","club"].forEach(enableToggleMulti);
  
  function hideWelcome() {
	  const welcome = document.getElementById("welcome-screen");
	  welcome.style.display = "none";
	  welcome.setAttribute("hidden", true);
	  sessionStorage.setItem("welcomeShown", "true");
	}

	function showWelcomeAgain() {
	const welcome = document.getElementById("welcome-screen");
	welcome.style.display = "flex";
	}
	document.addEventListener("DOMContentLoaded", () => {
	  const welcome = document.getElementById("welcome-screen");
	  const alreadyShown = sessionStorage.getItem("welcomeShown");
	  console.log("SessionStorage says welcomeShown:", alreadyShown);
	  
	  if (alreadyShown === "true") {
		welcome.setAttribute("hidden", true);
		welcome.style.display = "none";
	  } else {
		welcome.removeAttribute("hidden");
		welcome.style.display = "flex";
	  }
	});
  function currentFilters(){
    return {
      country: selVals("country"),
      league:  selVals("league"),
      club:    selVals("club"),
    };
  }

  const statusEl = document.getElementById('status');
  function setStatus(msg){ statusEl.textContent = msg || ''; }

  // ---------- cascade options ----------
  async function refreshCascades(){
    const f = encodeURIComponent(JSON.stringify(currentFilters()));
    // refresh in order so each is scoped by those to its left
    for (const id of ["country","league","club"]){
      const r = await fetch(`/api/options?column=${id}&filters=${f}`);
      const data = await r.json();
      fill(id, data.values || []);
    }
  }

  // ---------- data search + render ----------
  let map, markersLayer;
  const markerIndex = {};

  function ensureMap(){
    if (!map){
      map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      // initial safe view
      map.setView([20, 0], 2);
      // ensure map renders if container was sized after init
      setTimeout(()=> map.invalidateSize(), 0);
    }
  }
  let highlightedKey = null;

  function keyFrom(m){ return `${m.team_name}||${m.stadium_name}`; }

  function renderMarkers(markers){
    markersLayer.clearLayers();
    Object.keys(markerIndex).forEach(k => delete markerIndex[k]);

    if (!markers || !markers.length){
      map.setView([20, 0], 2);
      map.invalidateSize();
      return;
    }
    const bounds = [];
    markers.forEach(m => {
      const popup = `
        <strong>${m.stadium_name}</strong><br/>
        ${m.team_name} — <small>${m.country}</small><br/>
        <small>Lon ${m.lon}, Lat ${m.lat}</small>
      `;
      const cm = L.circleMarker([m.lat, m.lon], {
		  radius: 5,
		  color: '#FF0000',      // outline color
		  fillColor: '#FF6666',  // inner fill color
		  fillOpacity: 0.8
		});
      cm.bindPopup(popup).addTo(markersLayer);
      const k = keyFrom(m);
      markerIndex[k] = cm;
      bounds.push([m.lat, m.lon]);
    });
    try { map.fitBounds(bounds, {padding:[20,20]}); } catch {}
    map.invalidateSize();
  }

  function highlightMarker(key, on){
    const m = markerIndex[key];
    if (!m) return;
    m.setStyle(on ? { radius: 8, weight: 2 } : { radius: 5, weight: 1 });
    if (on) m.bringToFront();
  }

  function rowKey(r){ return `${r.team_name}||${r.stadium_name}`; }

  function renderTable(rows){
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = (rows||[]).map(r => `
      <tr data-key="${rowKey(r)}">
        <td>${r.team_name || ''}</td>
        <td>${r.country || ''}</td>
        <td>${r.stadium_name || ''}</td>
        <td>${r.lon ?? ''}</td>
        <td>${r.lat ?? ''}</td>
      </tr>
    `).join('');
	// Hover → highlight
		tbody.querySelectorAll('tr').forEach(tr => {
		  tr.addEventListener('mouseenter', () => {
			const k = tr.getAttribute('data-key');
			highlightedKey = k;
			highlightMarker(k, true);
		  });
		  tr.addEventListener('mouseleave', () => {
			const k = tr.getAttribute('data-key');
			if (k === highlightedKey) highlightedKey = null;
			highlightMarker(k, false);
		  });
		  tr.addEventListener('click', () => {
			const k = tr.getAttribute('data-key');
			const m = markerIndex[k];
			if (!m) return;
			const ll = m.getLatLng();
			map.setView(ll, Math.max(map.getZoom(), 10), { animate: true });
			m.openPopup();
		  });
		});
	  }	
  async function search(){
    setStatus('Loading…');
    const f = encodeURIComponent(JSON.stringify(currentFilters()));
    const res = await fetch(`/api/stadiums/search?filters=${f}`);
    const {rows, markers} = await res.json();
    renderTable(rows);
    ensureMap();
    renderMarkers(markers);
    setStatus(`${rows.length || 0} result${(rows.length||0)===1?'':'s'}`);
  }

  // ---------- live behavior (like Fixtures) ----------
  // preload selects (includes club from backend)
  ["country","league","club"].forEach(id => fill(id, preload[id] || []));

  // Like Fixtures: change in any select => cascade + search (debounced)
  let t;
  function kick(){
    clearTimeout(t);
    t = setTimeout(async ()=>{ await refreshCascades(); await search(); }, 120);
  }
  ["country","league","club"].forEach(id => {
    document.getElementById(id).addEventListener('change', kick);
  });

  document.getElementById("clearBtn").addEventListener("click", async ()=>{
    ["country","league","club"].forEach(id => document.getElementById(id).selectedIndex = -1);
    await refreshCascades();
    await search();
  });

  // initial
  ensureMap();
  refreshCountBadges();
  (async ()=>{ await refreshCascades(); await search(); })();
</script>
</body>
</html>