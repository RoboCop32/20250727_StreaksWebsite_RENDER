<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Stadium Explorer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root { --gap: 14px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 18px; }
    header { display:flex; align-items:center; gap: 12px; margin-bottom: 12px; }
    .btn { padding: 8px 12px; border:1px solid #ddd; border-radius:10px; text-decoration:none; color:#111; background:#fafafa }
    .btn:hover { background:#f0f0f0 }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .card { border:1px solid #e7e7e7; border-radius:12px; padding:12px; background:#fff; position:relative; }
    label { display:block; font-size:.85rem; color:#555; margin-bottom:4px; }
    select { width:100%; padding:8px; border-radius:8px; border:1px solid #ddd; }
    #map { height: 520px; border-radius:12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #eee; text-align:left; padding:8px; }
    thead th { background:#fff; position: sticky; top: 0; z-index: 3; box-shadow: 0 1px 0 #eee; }
    .row { display:grid; grid-template-columns: repeat(2, 1fr); gap: var(--gap); }
    @media (max-width: 1100px) { .grid { grid-template-columns: 1fr } }
    #tbl tbody tr { cursor: pointer; }
    #tbl tbody tr:hover { background: #f8f8f8; }
    .count-badge{ font-size:.75rem; color:#555; margin-left:6px }
  </style>
</head>
<body>
  <header>
    <h2 style="margin:0">Stadium Explorer</h2>
    <div style="display:flex; gap:8px;">
      <a class="btn" href="/filters">Go to fixtures page</a>
      <a class="btn" href="/streak">Go to streak page</a>
    </div>
  </header>

  <div class="grid">
    <!-- Left: filters & map -->
    <div class="card">
      <div class="row">
        <div>
          <label>Country <span class="count-badge" id="country-count"></span></label>
          <select id="country" multiple size="10"></select>
        </div>
        <div>
          <label>League <span class="count-badge" id="league-count"></span></label>
          <select id="league" multiple size="10"></select>
        </div>
      </div>

      <div style="display:flex; gap:8px; margin-top:10px;">
        <button id="searchBtn" class="btn">Apply filters</button>
        <button id="clearBtn" class="btn">Clear</button>
      </div>

      <div id="map" style="margin-top:12px;"></div>
    </div>

    <!-- Right: stadiums table -->
    <div class="card table-card" style="overflow:auto; max-height: 720px;">
      <table id="tbl">
        <thead>
          <tr>
            <th>Team Name</th>
            <th>Stadium Name</th>
            <th>Country</th>
            <th>League</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const preload = {{ preload|tojson|safe }};

    function optHtml(arr){ return ['<option value="">(any)</option>'].concat((arr||[]).map(v=>`<option>${v}</option>`)).join(''); }
    function selVals(id){ return Array.from(document.getElementById(id).selectedOptions).map(o=>o.value).filter(Boolean); }
    function fill(id, arr){
      const el = document.getElementById(id);
      const prev = new Set(selVals(id));
      el.innerHTML = optHtml(arr);
      Array.from(el.options).forEach(opt => { if (prev.has(opt.value)) opt.selected = true; });
      refreshCountBadges();
    }
    ["country","league"].forEach(id => fill(id, preload[id]));

    function currentFilters(){
      return {
        country: selVals("country"),
        league:  selVals("league"),
      };
    }

    async function refreshCascades(){
      const f = encodeURIComponent(JSON.stringify(currentFilters()));
      for (const id of ["country","league"]){
        const r = await fetch(`/api/options?column=${id}&filters=${f}`);
        const data = await r.json();
        fill(id, data.values || []);
      }
      refreshCountBadges();
    }

    // Map
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19, attribution:'&copy; OpenStreetMap'}).addTo(map);
    let markerLayer = L.layerGroup().addTo(map);
    let hoverLayer = L.layerGroup().addTo(map); // transient highlight
    const markerById = new Map();
    const latlngById = new Map();

    function refreshCountBadges(){
      const counts = {
        country: document.querySelectorAll('#country option:checked').length,
        league:  document.querySelectorAll('#league option:checked').length,
      };
      for (const k of Object.keys(counts)){
        const el = document.getElementById(`${k}-count`);
        if (el) el.textContent = counts[k] ? `(${counts[k]} selected)` : '';
      }
    }

    function enableToggleMulti(id){
      const el = document.getElementById(id);
      el.addEventListener('mousedown', (e) => {
        const opt = e.target;
        if (opt && opt.tagName === 'OPTION') {
          e.preventDefault();
          opt.selected = !opt.selected;
          el.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
    }
    ["country","league"].forEach(enableToggleMulti);

    async function search(){
      const f = encodeURIComponent(JSON.stringify(currentFilters()));
      const res = await fetch(`/api/stadiums/search?filters=${f}`);
      const {rows, markers} = await res.json();

      // table
      const tbody = document.querySelector("#tbl tbody");
      tbody.innerHTML = "";
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.dataset.id = r.id;
        tr.dataset.lat = r.Latitude ?? "";
        tr.dataset.lng = r.Longitude ?? "";
        tr.innerHTML = `
          <td>${r["Team Name"] || ""}</td>
          <td>${r["Stadium Name"] || ""}</td>
          <td>${r["Country"] || ""}</td>
          <td>${r["League"] || ""}</td>
        `;
        // hover highlight
        tr.addEventListener("mouseenter", ()=>{
          hoverLayer.clearLayers();
          const lat = parseFloat(tr.dataset.lat), lng = parseFloat(tr.dataset.lng);
          if (!isNaN(lat) && !isNaN(lng)) {
            L.circleMarker([lat, lng], {radius: 10, weight: 3, color: '#ff3b30', fillOpacity: 0.15}).addTo(hoverLayer);
          }
        });
        tr.addEventListener("mouseleave", ()=>hoverLayer.clearLayers());
        // click -> zoom + open popup
        tr.addEventListener("click", ()=>{
          const id = +tr.dataset.id;
          const mk = markerById.get(id);
          const ll = latlngById.get(id);
          if (ll) {
            map.setView(ll, 14);
          }
          if (mk) mk.openPopup();
        });
        tbody.appendChild(tr);
      });

      // markers
      markerLayer.clearLayers();
      hoverLayer.clearLayers();
      markerById.clear();
      latlngById.clear();
      const bounds = [];
      (markers || []).forEach(m=>{
        const ll = [m.lat, m.lng];
        const mk = L.marker(ll).bindPopup(m.popup);
        mk.addTo(markerLayer);
        markerById.set(m.id, mk);
        latlngById.set(m.id, ll);
        bounds.push(ll);
      });
      if (bounds.length){ map.fitBounds(bounds, {padding:[20,20]}); } else { map.setView([20,0],2); }
    }

    document.getElementById("clearBtn").addEventListener("click", async ()=>{
      ["country","league"].forEach(id => document.getElementById(id).selectedIndex = -1);
      await refreshCascades();
      await search();
    });

    document.getElementById("searchBtn").addEventListener("click", async ()=>{
      await refreshCascades();
      await search();
    });

    // initial
    refreshCountBadges();
    search();
  </script>
</body>
</html>