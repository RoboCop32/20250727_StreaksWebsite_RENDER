<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Stadium Explorer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
  :root { --gap: 14px; }
  
  body {background: #59A6FF; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 18px; }
  header { display:flex; align-items:center; gap: 12px; margin-bottom: 12px; }
  .btn { padding: 8px 12px; border:1px solid #ddd; border-radius:10px; text-decoration:none; color:#111; background:#fafafa }
  .btn:hover { background:#f0f0f0 }

  .card { border:1px solid #e7e7e7; border-radius:12px; padding:12px; background:#fff; position:relative; }

  /* Filters: 3 thin columns in a row */
  .filters-row {
    display:grid;
    grid-template-columns: repeat(3, minmax(160px, 1fr));
    gap: var(--gap);
    margin-bottom: var(--gap);
  }
  .filter { display:flex; flex-direction:column; gap:6px; }
  label { font-weight:600; font-size: 14px; }
  select[multiple] {
    min-height: 180px;
    border:1px solid #ddd; border-radius:10px; padding:8px;
    font-size: 14px; background:#fff;
  }
  .count-badge { font-weight:400; color:#666; margin-left:6px; }

  .two-col {
    display: grid;
    grid-template-columns: 1.2fr 1fr;   /* map left (wider), table right */
    gap: 14px;
  }
  @media (max-width: 900px){
    .two-col { grid-template-columns: 1fr; }
  }
  #map { width: 100%; min-height: 480px; border-radius: 10px; }
  #tableCard { max-height: 480px; overflow: auto; }

</style>
</head>
<body>
  <header>
    <h2 style="margin:0">Stadium Explorer</h2>
    <div style="display:flex; gap:8px;">
		<a class="btn" href="/">← Home</a>
    </div>
  </header>

  <div class="card">
  <div class="filters-row">
    <div class="filter">
      <label>Country <span class="count-badge" id="country-count"></span></label>
      <select id="country" multiple></select>
    </div>
    <div class="filter">
      <label>League <span class="count-badge" id="league-count"></span></label>
      <select id="league" multiple></select>
    </div>
    <div class="filter">
      <label>Club <span class="count-badge" id="club-count"></span></label>
      <select id="club" multiple></select>
    </div>
  </div>

  <div class="actions">
    <button id="clearBtn" class="btn">Clear</button>
    <span id="status" aria-live="polite"></span>
  </div>
</div>

<div class="two-col">
  <div id="mapCard" class="card">
    <div id="map"></div>
  </div>

  <div id="tableCard" class="card">
    <table>
      <thead>
        <tr>
          <th>Team Name</th>
          <th>Country</th>
          <th>Stadium Name</th>
          <th>Longitude</th>
          <th>Latitude</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

 <script>
  // Preloaded distincts injected by Flask:
  const preload = {{ preload|tojson|safe }};

  // ---------- helpers ----------
  function optHtml(arr){ return ['<option value="">(any)</option>'].concat((arr||[]).map(v=>`<option>${v}</option>`)).join(''); }
  function selVals(id){ return Array.from(document.getElementById(id).selectedOptions).map(o=>o.value).filter(Boolean); }
  function fill(id, arr){
    const el = document.getElementById(id);
    const prev = new Set(selVals(id));
    el.innerHTML = optHtml(arr);
    Array.from(el.options).forEach(opt => { if (prev.has(opt.value)) opt.selected = true; });
    refreshCountBadges();
  }
  function refreshCountBadges(){
    const n = k => document.querySelectorAll(`#${k} option:checked`).length;
    const set = (k,v)=>{ const el = document.getElementById(`${k}-count`); if (el) el.textContent = v ? `(${v} selected)` : ''; };
    set('country', n('country')); set('league', n('league')); set('club', n('club'));
  }
  function enableToggleMulti(id){
    const el = document.getElementById(id);
    el.addEventListener('mousedown', (e) => {
      const opt = e.target;
      if (opt && opt.tagName === 'OPTION') {
        e.preventDefault();
        opt.selected = !opt.selected;
        el.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });
  }
  ["country","league","club"].forEach(enableToggleMulti);

  function currentFilters(){
    return {
      country: selVals("country"),
      league:  selVals("league"),
      club:    selVals("club"),
    };
  }

  const statusEl = document.getElementById('status');
  function setStatus(msg){ statusEl.textContent = msg || ''; }

  // ---------- cascade options ----------
  async function refreshCascades(){
    const f = encodeURIComponent(JSON.stringify(currentFilters()));
    // refresh in order so each is scoped by those to its left
    for (const id of ["country","league","club"]){
      const r = await fetch(`/api/options?column=${id}&filters=${f}`);
      const data = await r.json();
      fill(id, data.values || []);
    }
  }

  // ---------- data search + render ----------
  let map, markersLayer;

  function ensureMap(){
    if (!map){
      map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      // initial safe view
      map.setView([20, 0], 2);
      // ensure map renders if container was sized after init
      setTimeout(()=> map.invalidateSize(), 0);
    }
  }
  let highlightedKey = null;

  function keyFrom(m){ return `${m.team_name}||${m.stadium_name}`; }

  function renderMarkers(markers){
    markersLayer.clearLayers();
    Object.keys(markerIndex).forEach(k => delete markerIndex[k]);

    if (!markers || !markers.length){
      map.setView([20, 0], 2);
      map.invalidateSize();
      return;
    }
    const bounds = [];
    markers.forEach(m => {
      const popup = `
        <strong>${m.stadium_name}</strong><br/>
        ${m.team_name} — <small>${m.country}</small><br/>
        <small>Lon ${m.lon}, Lat ${m.lat}</small>
      `;
      const cm = L.circleMarker([m.lat, m.lon], { radius: 6 });
      cm.bindPopup(popup).addTo(markersLayer);
      const k = keyFrom(m);
      markerIndex[k] = cm;
      bounds.push([m.lat, m.lat ? m.lon : m.lon]); // keep bounds growing
      bounds.push([m.lat, m.lon]);
    });
    try { map.fitBounds(bounds, {padding:[20,20]}); } catch {}
    map.invalidateSize();
  }

  function highlightMarker(key, on){
    const m = markerIndex[key];
    if (!m) return;
    m.setStyle(on ? { radius: 9, weight: 2 } : { radius: 6, weight: 1 });
    if (on) m.bringToFront();
  }

  function rowKey(r){ return `${r.team_name}||${r.stadium_name}`; }

  function renderTable(rows){
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = (rows||[]).map(r => `
      <tr data-key="${rowKey(r)}">
        <td>${r.team_name || ''}</td>
        <td>${r.country || ''}</td>
        <td>${r.stadium_name || ''}</td>
        <td>${r.lon ?? ''}</td>
        <td>${r.lat ?? ''}</td>
      </tr>
    `).join('');
	// Hover → highlight
		tbody.querySelectorAll('tr').forEach(tr => {
		  tr.addEventListener('mouseenter', () => {
			const k = tr.getAttribute('data-key');
			highlightedKey = k;
			highlightMarker(k, true);
		  });
		  tr.addEventListener('mouseleave', () => {
			const k = tr.getAttribute('data-key');
			if (k === highlightedKey) highlightedKey = null;
			highlightMarker(k, false);
		  });
		  tr.addEventListener('click', () => {
			const k = tr.getAttribute('data-key');
			const m = markerIndex[k];
			if (!m) return;
			const ll = m.getLatLng();
			map.setView(ll, Math.max(map.getZoom(), 10), { animate: true });
			m.openPopup();
		  });
		});
	  }	
  async function search(){
    setStatus('Loading…');
    const f = encodeURIComponent(JSON.stringify(currentFilters()));
    const res = await fetch(`/api/stadiums/search?filters=${f}`);
    const {rows, markers} = await res.json();
    renderTable(rows);
    ensureMap();
    renderMarkers(markers);
    setStatus(`${rows.length || 0} result${(rows.length||0)===1?'':'s'}`);
  }

  // ---------- live behavior (like Fixtures) ----------
  // preload selects (includes club from backend)
  ["country","league","club"].forEach(id => fill(id, preload[id] || []));

  // Like Fixtures: change in any select => cascade + search (debounced)
  let t;
  function kick(){
    clearTimeout(t);
    t = setTimeout(async ()=>{ await refreshCascades(); await search(); }, 120);
  }
  ["country","league","club"].forEach(id => {
    document.getElementById(id).addEventListener('change', kick);
  });

  document.getElementById("clearBtn").addEventListener("click", async ()=>{
    ["country","league","club"].forEach(id => document.getElementById(id).selectedIndex = -1);
    await refreshCascades();
    await search();
  });

  // initial
  ensureMap();
  refreshCountBadges();
  (async ()=>{ await refreshCascades(); await search(); })();
</script>
</body>
</html>